templates:
  ############# INTERVENTIONS #############

  # Control conversation
  - templateName: control_conversation_pre
    contentType: elements
    templateContent:
      - type: prompt
        file: projects/css_lab/dl_collab/pilot_2/game/arms/c1/pre.md
      - type: submitButton
        name: control_conversation_pre
        buttonText: Continue to Discussion

  ############## REPEATED PIECES ##############
  # Displays a stage asking the user's opinion and knowledge of the topic,
  # used in the intro sequence to gauge opinions.
  - templateName: topicPrompt
    contentType: introExitSteps
    templateContent:
      - name: ${topicName}_presurvey
        elements:
          - type: prompt
            file: projects/css_lab/dl_collab/pilot_2/intro/consider_topic.md

          - type: prompt
            file: "projects/css_lab/dl_collab/pilot_2/topics/${topicName}.md"

          - type: prompt
            name: presurvey_${topicName}
            file: projects/css_lab/dl_collab/pilot_2/intro/topic_opinion.md

          - type: prompt
            name: presurvey_${topicName}_familiarity
            file: projects/css_lab/dl_collab/pilot_2/intro/topic_familiarity.md

          - type: submitButton
            buttonText: Continue
            name: presurvey_${topicName}
            conditions:
              - reference: prompt.presurvey_${topicName}
                comparator: exists
              - reference: prompt.presurvey_${topicName}_familiarity
                comparator: exists

  ############# GENERIC STRUCTURE #############

  - templateName: condition
    contentType: treatment
    templateContent:
      name: ${conditionName}
      playerCount: 2
      groupComposition:
        - position: 0
          title: In Favor
          conditions:
            - reference: prompt.presurvey_${topicName}
              comparator: includes
              value: "favor" # Q: should we only use "strongly favor" here?
            - reference: prompt.presurvey_${topicName}_familiarity
              comparator: isOneOf
              value: ["Very familiar", "Moderately familiar"]
        - position: 1
          title: Opposed
          conditions:
            - reference: prompt.presurvey_${topicName}
              comparator: includes
              value: "oppose" # Q: should we only use "strongly oppose" here?
            - reference: prompt.presurvey_${topicName}_familiarity
              comparator: isOneOf
              value: ["Very familiar", "Moderately familiar"]

      gameStages:
        - name: AttitudeAttributes
          duration: 300
          elements:
            - type: audio
              file: shared/westminster_short.mp3 # Todo: Remove when this becomes default?

            - type: prompt
              file: projects/css_lab/dl_collab/pilot_2/game/attitude_attribute_instructions_A.md
            - type: prompt
              file: "projects/css_lab/dl_collab/pilot_2/topics/${topicName}.md"
            - type: display
              reference: prompt.presurvey_${topicName}
              position: player

            - type: prompt
              file: projects/css_lab/dl_collab/pilot_2/game/attitude_attribute_instructions_B.md
            - type: survey
              name: attitudeAttributes
              surveyName: AttitudeAttributes

        - name: preDiscussionIntervention
          duration: 300
          elements:
            - template: ${interventionName}_pre
              fields:
                topicName: "${topicName}"

        - name: Discussion
          duration: 900 # 15 minutes exactly
          discussion:
            chatType: video
            showNickname: true
            showTitle: false # Should we display "In Favor" / "Opposed" next to names?
          elements:
            # Persistent instructions
            - type: prompt
              file: projects/css_lab/dl_collab/pilot_2/game/arms/{arm}/mid_A.md
            - type: prompt
              file: "projects/css_lab/dl_collab/pilot_2/topics/${topicName}.md"
            - type: prompt
              file: projects/css_lab/dl_collab/pilot_2/game/arms/{arm}/mid_B.md

            # End-of-call alert (after 14 minutes)
            - type: prompt
              file: projects/css_lab/dl_collab/pilot_2/game/call_end_alert.md
              displayTime: 840
            - type: audio
              file: shared/counter_bell.mp3
              displayTime: 840

        - name: describePartnerViews
          duration: 300
          elements:
            - type: prompt
              file: projects/css_lab/dl_collab/pilot_2/game/describe_partner_views.md
              name: describePartnerViews

            - type: submitButton
              buttonText: Continue
              name: describePartnerViews
              displayTime: 180 # Require they spend at least 3 minutes on this step
              conditions:
                - reference: prompt.describePartnerViews
                  comparator: hasLengthAtLeast
                  value: 300 # Require at least 300 characters

      exitSequence:
        - name: willingnessToReengageSelfReportPost

        - name: willingnessToReengageSignup

        - name: attitudeAttributesPost
          # Add attitude extremity scale, attitude attributes survey

        - name: perceptionOfDiscussion
          elements:
            - type: survey
              name: discussionGeneral
              surveyName: DiscussionGeneral

        - name: perceptionOfPartner
          elements:
            - type: prompt
              file: projects/css_lab/ct_topic/consider_partner.md

            - type: display
              reference: participantInfo.name
              position: 0
              showToPositions: [1]
            - type: display
              reference: participantInfo.name
              position: 1
              showToPositions: [0]

            - type: survey
              name: PerceptionOfPartner
              surveyName: PerceptionOfOthers

        - name: ratePartnerDescription
          elements:
            - type: prompt
              file: projects/css_lab/dl_collab/pilot_2/exit/scoreDescriptionInstructions.md

            - type: display
              reference: prompt.describePartnerViews
              position: 0
              showToPositions: [1]

            - type: display
              reference: prompt.describePartnerViews
              position: 1
              showToPositions: [0]

            - type: prompt
              name: scoreDescriptionCompleteness
              file: projects/css_lab/dl_collab/pilot_2/exit/scoreDescriptionCompleteness.md

            - type: prompt
              name: scoreDescriptionFairness
              file: projects/css_lab/dl_collab/pilot_2/exit/scoreDescriptionFairness.md

            - type: prompt
              name: scoreDescriptionInstructions
              file: projects/css_lab/dl_collab/pilot_2/exit/scoreDescriptionInstructions.md
####### INTRO SEQUENCES #######

####### TREATMENT DEFINITIONS #######
